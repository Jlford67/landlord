// prisma/schema.prisma
// Prisma 7+ note: datasource `url` is configured in prisma.config.ts (not here).

datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  owner
  spouse
  readonly
}

enum LeaseStatus {
  upcoming
  active
  ended
}

enum NotificationStatus {
  new
  read
  done
  dismissed
}

enum CategoryType {
  income
  expense
  transfer
}

enum TransactionSource {
  manual
  pm_import
  tax_year_import
}

enum NotificationChannel {
  inapp
  email
}

enum NotificationEventType {
  insurance_due
  property_tax_due
}

enum NotificationDeliveryStatus {
  queued
  sent
  failed
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(owner)
  createdAt    DateTime @default(now())

  notificationRules NotificationRule[]
  notifications     Notification[]
  sessions          Session[]
}

model Entity {
  id        String   @id @default(cuid())
  name      String
  type      String // "personal", "llc", etc.
  notes     String?
  createdAt DateTime @default(now())

  ownerships PropertyOwnership[]
}

model Property {
  id                        String    @id @default(cuid())
  nickname                  String?
  street                    String
  city                      String
  state                     String
  zip                       String
  doors                     Int?
  beds                      Float?
  baths                     Float?
  sqFt                      Int?
  status                    String    @default("active") // active/sold/watchlist
  purchasePriceCents        Int?
  purchaseDate              DateTime?
  soldPriceCents            Int?
  soldDate                  DateTime?
  notes                     String?
  zillowUrl                 String?
  redfinUrl                 String?
  zillowEstimatedValue              Int?
  zillowEstimatedValueUpdatedAt     DateTime?

  redfinEstimatedValue              Int?
  redfinEstimatedValueUpdatedAt     DateTime?

  createdAt                 DateTime  @default(now())

  ownerships            PropertyOwnership[]
  loans                 Loan[]
  taxAccounts           PropertyTaxAccount[]
  insurance             InsurancePolicy[]
  pmAssignments         PropertyManagerAssignment[]
  leases                Lease[]
  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]
  notifications         Notification[]
  annualCategoryAmounts AnnualCategoryAmount[]
}

model PropertyOwnership {
  id           String    @id @default(cuid())
  propertyId   String
  entityId     String
  ownershipPct Float     @default(100)
  startDate    DateTime?
  endDate      DateTime?

  property              Property               @relation(fields: [propertyId], references: [id])
  entity                Entity                 @relation(fields: [entityId], references: [id])
  annualCategoryAmounts AnnualCategoryAmount[]

  @@index([propertyId])
  @@index([entityId])
}

model Tenant {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())

  leaseTenants LeaseTenant[]
}

model Lease {
  id          String      @id @default(cuid())
  propertyId  String
  startDate   DateTime
  endDate     DateTime?
  rentAmount  Float
  dueDay      Int         @default(1)
  deposit     Float?
  unitLabel   String?
  status      LeaseStatus @default(active)
  managedByPm Boolean     @default(true)
  notes       String?
  createdAt   DateTime    @default(now())

  property     Property      @relation(fields: [propertyId], references: [id])
  leaseTenants LeaseTenant[]
}

model LeaseTenant {
  id       String @id @default(cuid())
  leaseId  String
  tenantId String
  role     String @default("primary")

  lease  Lease  @relation(fields: [leaseId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([leaseId, tenantId])
}

model PropertyManagerCompany {
  id       String  @id @default(cuid())
  name     String  @unique
  phone    String?
  email    String?
  website  String?
  address1 String?
  city     String?
  state    String?
  zip      String?
  notes    String?

  contacts    PropertyManagerContact[]
  assignments PropertyManagerAssignment[]
}

model PropertyManagerContact {
  id        String  @id @default(cuid())
  companyId String
  name      String
  phone     String?
  email     String?
  notes     String?

  company     PropertyManagerCompany      @relation(fields: [companyId], references: [id])
  assignments PropertyManagerAssignment[]

  @@index([companyId])
}

model PropertyManagerAssignment {
  id         String    @id @default(cuid())
  propertyId String    @unique
  companyId  String
  contactId  String?
  startDate  DateTime?
  endDate    DateTime?
  notes      String?

  property Property               @relation(fields: [propertyId], references: [id])
  company  PropertyManagerCompany @relation(fields: [companyId], references: [id])
  contact  PropertyManagerContact? @relation(fields: [contactId], references: [id])

  @@index([companyId])
  @@index([contactId])
}

model AnnualCategoryAmount {
  id         String @id @default(cuid())
  propertyId String
  year       Int
  categoryId String

  // Match Transaction style: +income, -expense
  amount Float

  // Exists in DB and is part of the unique constraint
  importKey String @default("")

  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property            Property           @relation(fields: [propertyId], references: [id])
  category            Category           @relation(fields: [categoryId], references: [id])
  propertyOwnership   PropertyOwnership? @relation(fields: [propertyOwnershipId], references: [id])
  propertyOwnershipId String?

  @@unique([propertyId, year, categoryId, propertyOwnershipId, importKey])
  @@index([propertyId, year])
  @@index([categoryId])
}


model Loan {
  id         String    @id @default(cuid())
  propertyId String
  lenderName String?
  bankNumber String?
  origAmount Float?
  origDate   DateTime?
  ratePct    Float?
  termYears  Int?
  payoffDate DateTime?
  notes      String?

  property  Property       @relation(fields: [propertyId], references: [id])
  snapshots LoanSnapshot[]
}

model LoanSnapshot {
  id        String   @id @default(cuid())
  loanId    String
  asOfDate  DateTime
  balance   Float
  principal Float?
  interest  Float?
  extraPrin Float?

  loan Loan @relation(fields: [loanId], references: [id])

  @@index([loanId, asOfDate])
}

model PropertyTaxAccount {
  id           String    @id @default(cuid())
  propertyId   String
  annualAmount Float?
  dueDate      DateTime? // annual
  lastPaid     DateTime?
  parcel       String?
  billNumber   String?
  phone        String?
  name         String?
  address1     String?
  address2     String?
  city         String?
  state        String?
  zip          String?
  web          String?
  email        String?

  property Property @relation(fields: [propertyId], references: [id])

  @@index([propertyId])
}

model InsurancePolicy {
  id          String    @id @default(cuid())
  propertyId  String
  insurer     String?
  policyNum   String?
  agentName   String?
  premium     Float?
  dueDate     DateTime?
  paidDate    DateTime?
  phone       String?
  webPortal   String?
  allPolicies String?
  bank        String?
  bankNumber  String?
  loanRef     String?

  property Property @relation(fields: [propertyId], references: [id])

  @@index([propertyId])
}

model Category {
  id     String       @id @default(cuid())
  type   CategoryType
  name   String
  active Boolean      @default(true)

  parentId String?
  parent   Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children Category[] @relation("CategoryParent")

  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]
  annualCategoryAmounts AnnualCategoryAmount[]

  @@index([type])
  @@index([parentId])
}

model Transaction {
  id         String            @id @default(cuid())
  propertyId String
  date       DateTime
  categoryId String
  amount     Float // +income, -expense
  payee      String?
  memo       String?
  source     TransactionSource @default(manual)
  deletedAt  DateTime?

  // monthly reconciliation helpers
  statementMonth String? // "2025-11" groups a PM statement month
  isOwnerPayout  Boolean @default(false) // the deposit you received

  property Property @relation(fields: [propertyId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@index([propertyId, date])
  @@index([statementMonth])
  @@index([categoryId])
  @@index([propertyId, deletedAt])
}

model RecurringTransaction {
  id         String   @id @default(cuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  amountCents Int
  memo        String?
  dayOfMonth  Int     @default(1) // 1-28 recommended
  startMonth  String // "YYYY-MM"
  endMonth    String? // "YYYY-MM" optional
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  postings RecurringPosting[]

  @@index([propertyId])
  @@index([categoryId])
}

model RecurringPosting {
  id                     String               @id @default(cuid())
  recurringTransactionId String
  recurringTransaction   RecurringTransaction @relation(fields: [recurringTransactionId], references: [id], onDelete: Cascade)

  month               String // "YYYY-MM"
  ledgerTransactionId String   @unique
  createdAt           DateTime @default(now())

  @@unique([recurringTransactionId, month])
  @@index([month])
}

model NotificationRule {
  id         String  @id @default(cuid())
  userId     String
  ruleType   String // lease_expiry, tax_due, insurance_due
  daysBefore Int
  channels   String // store JSON like ["in_app","email"]
  enabled    Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id         String             @id @default(cuid())
  userId     String
  propertyId String?
  dueDate    DateTime?
  eventType  String
  title      String
  body       String?
  status     NotificationStatus @default(new)
  createdAt  DateTime           @default(now())
  sentAt     DateTime?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id])

  @@index([userId, status])
  @@index([propertyId])
  @@index([dueDate])
}

model NotificationSettings {
  id                   String   @id @default(cuid())
  enabled              Boolean  @default(true)
  inAppEnabled         Boolean  @default(true)
  emailEnabled         Boolean  @default(true)
  emailAddress         String?
  emailSendTimeLocal   String   @default("08:00")
  insuranceEnabled     Boolean  @default(true)
  insuranceStartDays   Int      @default(60)
  insuranceOffsetsCsv  String   @default("60,30,14,7,1")
  insuranceOverdueDaily Boolean @default(true)
  propertyTaxEnabled   Boolean  @default(true)
  propertyTaxStartDays Int      @default(60)
  propertyTaxOffsetsCsv String  @default("60,30,14,7,1")
  propertyTaxOverdueDaily Boolean @default(true)
  lastGeneratedAt      DateTime?
  updatedAt            DateTime @updatedAt
}

model NotificationEvent {
  id              String                   @id @default(cuid())
  createdAt       DateTime                 @default(now())
  channel         NotificationChannel
  type            NotificationEventType
  propertyId      String?
  relatedEntityId String?
  dueDate         DateTime?
  message         String
  acknowledgedAt  DateTime?
  sentAt          DateTime?
  status          NotificationDeliveryStatus @default(queued)
  dedupeKey       String                   @unique
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
